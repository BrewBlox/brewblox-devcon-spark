name: CI build

on:
  push:
    branches: ["*"]
  pull_request:
    branches: [develop, edge]

jobs:
  build:
    if: github.repository_owner == 'BrewBlox'
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Export build variables
        run: |
          echo "TAG=$(echo "$GITHUB_REF_NAME" | tr '/' '-' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Install Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry wheel
          poetry install
          sudo apt update
          sudo apt install -y socat

      - name: Download firmware
        run: |
          bash dev/download-firmware.sh

      - name: Test
        run: |
          poetry run pytest
          poetry run flake8

      - name: Enable multiplatform Docker build
        uses: docker/setup-qemu-action@v2
        if: github.event_name != 'pull_request'

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2
        if: github.event_name != 'pull_request'

      - name: ghcr.io login
        uses: docker/login-action@v2
        if: github.event_name != 'pull_request'
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: (Service) Run setup script
        run: |
          bash docker/before_build.sh

      - name: (Service) Build Docker image
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: brewblox/brewblox-devcon-spark:$TAG
          platforms: linux/amd64,linux/arm/v7,linux/arm64/v8
          context: docker

      - name: (Flasher) Run setup script
        run: |
          bash flasher/before_build.sh

      - name: (Flasher) Build Docker image
        uses: docker/build-push-action@v4
        with:
          push: true
          tags: brewblox/firmware-flasher:$TAG
          platforms: linux/amd64,linux/arm/v7,linux/arm64/v8
          context: flasher
